"use strict";function directionToRadian(e){switch(e){case"n":return 0;case"nw":return 1;case"w":return 2;case"sw":return 3;case"s":return 4;case"se":return 5;case"e":return 6;case"ne":return 7}}function getDirectionName(e){switch(e){case 0:return"North";case 1:return"North West";case 2:return"West";case 3:return"South West";case 4:return"South";case 5:return"South East";case 6:return"East";case 7:return"North East"}}function getRadianFromFixedDirection(e){return e*ONE_FOURTH_PI}function getDirection(e){var t=(Math.floor(e/ONE_SIXTH_PI)+12)%12;switch(t){case 0:return 0;case 1:return 1;case 2:case 3:return 2;case 4:return 3;case 5:case 6:return 4;case 7:return 5;case 8:case 9:return 6;case 11:return 7}}function saveToSessionStorage(){sessionStorage.houseType=houseType,sessionStorage.rooms=JSON.stringify(rooms),sessionStorage.currentRoom=JSON.stringify(currentRoom),sessionStorage.previousCeilingHeight=previousCeilingHeight}function addLine(e,t,r,n,o,i,a){var s=new THREE.Geometry;s.vertices.push(new THREE.Vector3(t,r,n)),s.vertices.push(new THREE.Vector3(o,i,a));var l=new THREE.Line(s,lineMaterial);e.add(l)}function calculateOuterInnerLines(e,t,r,n,o){var i=Math.atan(-1/((o-r)/(n-t))),a,s,l,c,u=r>o;return a=t-(u?-1:1)*e*Math.cos(i),s=r-e*Math.sin(i),l=n-(u?-1:1)*e*Math.cos(i),c=o-e*Math.sin(i),{outerX1New:t,outerY1New:r,outerX2New:n,outerY2New:o,innerX1New:a,innerY1New:s,innerX2New:l,innerY2New:c}}function getLineIntersection(e,t,r,n,o,i,a,s){var l=((e*n-t*r)*(o-a)-(e-r)*(o*s-i*a))/((e-r)*(i-s)-(t-n)*(o-a)),c=((e*n-t*r)*(i-s)-(t-n)*(o*s-i*a))/((e-r)*(i-s)-(t-n)*(o-a));return{x:l,y:c}}function constructRoom(e,t,r,n,o){for(var i=expandPoly(e.roomNormalisedPoints,r),a=e.roomNormalisedPoints,s=[],l=new THREE.Object3D,c=0;c<t.length;++c){var u=getPointIdx(t[c].start.id,a),h=getPointIdx(t[c].end.id,a),m=i[u],d=a[u],y=i[h],p=a[h],g=new THREE.Shape;g.moveTo(m.x,m.y),g.lineTo(d.x,d.y),g.lineTo(p.x,p.y),g.lineTo(y.x,y.y),g.lineTo(m.x,m.y);var x=new THREE.ExtrudeGeometry(g,{amount:n,bevelEnabled:!1}),E=new THREE.MeshLambertMaterial({color:o(c,t[c])});E.side=THREE.DoubleSide;var w=new THREE.Mesh(x,E);if(w.overdraw=!0,w.position.y=n,w.rotation.x=Math.PI/2,w.idx=c,t[c].windows){for(var v=new ThreeBSP(w),R=t[c].windows,T=new THREE.Object3D,f=0;f<R.length;++f){var S=new THREE.BoxGeometry(R[f].width,R[f].height,R[f].thickness),E=new THREE.MeshNormalMaterial({transparent:!0,opacity:.25});E.side=THREE.DoubleSide;var H=new THREE.Mesh(S,E);H.overdraw=!0,H.applyMatrix(R[f].rotationMatrix),H.position.set(R[f].x,R[f].y,R[f].z);var I=new ThreeBSP(H);I=I.intersect(v),v=v.subtract(I),H=I.toMesh(H.material),v=v.subtract(I),T.add(H)}var M=v.toMesh(w.material);T.add(M),l.add(T)}else l.add(w);s.push(w)}return{parent:l,objects:s}}function init3DRoom(e,t,r,n,o,i){var a=t.width(),s=t.height(),l=e.ceilingHeight*GRID_SIZE,c=new THREE.PerspectiveCamera(40,a/s,1,6e3);c.position.y=800,c.position.z=1500;var u=new THREE.OrbitControls(c,t[0]);u.addEventListener("change",n),u.maxPolarAngle=Math.PI/2-.001,u.minDistance=0,u.maxDistance=4e3;var h=new THREE.Scene,m=new THREE.PlaneGeometry(1e5,1e5),d=new THREE.MeshBasicMaterial({color:14540253,side:THREE.DoubleSide}),y=new THREE.Projector,p=new THREE.Vector3(0,1e4,.5),g=new THREE.AmbientLight(6316128);h.add(g);var x=new THREE.DirectionalLight(16777215);x.position.x=-.3704497358455519,x.position.y=.8303481835923215,x.position.z=-.4162798184117182,x.position.normalize(),h.add(x);var x=new THREE.DirectionalLight(8421504);x.position.x=.4314326373398046,x.position.y=.6372289487054973,x.position.z=.6385962310957584,x.position.normalize(),h.add(x);var E=new THREE.WebGLRenderer({antialias:!0,alpha:!0});E.setClearColor(0,0),E.setSize(a,s),t.append(E.domElement);var w=e.roomNormalisedLines,t=constructRoom(e,w,thickness,l,r),v=t.parent,R=t.objects,T=(new THREE.Box3).setFromObject(v),f=T.max.x-T.min.x,S=T.max.y-T.min.y,H=T.max.z-T.max.z,I=1|o;if(v.scale.x=I,v.scale.z=I,v.scale.y=I,i&&e.externalWallsIndexes.length>0){var M=e.roomNormalisedLines[e.externalWallsIndexes[0]];v.rotation.y=M.tetha+getRadianFromFixedDirection(M.direction)}return h.add(v),{controls:u,scene:h,camera:c,renderer:E,parent:v,objects:R}}function vecUnit(e){var t=Math.sqrt(e.x*e.x+e.y*e.y);return{x:e.x/t,y:e.y/t}}function vecMul(e,t){return{x:e.x*t,y:e.y*t}}function vecDot(e,t){return e.x*t.x+e.y*t.y}function vecRot90CW(e){return{x:e.y,y:-e.x}}function vecRot90CCW(e){return{x:-e.y,y:e.x}}function intersect(e,t){var r=e.end.x-e.start.x,n=t.start.x-t.end.x,o=t.start.x-e.start.x,i=e.end.y-e.start.y,a=t.start.y-t.end.y,s=t.start.y-e.start.y,l=(n*s-a*o)/(i*n-r*a);return{x:e.start.x+l*(e.end.x-e.start.x),y:e.start.y+l*(e.end.y-e.start.y)}}function polyIsCw(e){return vecDot(vecRot90CW({x:e[1].x-e[0].x,y:e[1].y-e[0].y}),{x:e[2].x-e[1].x,y:e[2].y-e[1].y})>=0}function getPointIdx(e,t){for(var r=0;r<t.length;r++)if(t[r].id==e)return r}function expandPoly(e,t){for(var r=[],n=polyIsCw(e)?vecRot90CCW:vecRot90CW,o=0;o<e.length;++o){var i=e[o>0?o-1:e.length-1],a=e[o],s=e[o<e.length-1?o+1:0],l={x:a.x-i.x,y:a.y-i.y},c={x:s.x-a.x,y:s.y-a.y},u=vecMul(vecUnit(n(l)),t),h=vecMul(vecUnit(n(c)),t),m={x:i.x+u.x,y:i.y+u.y},d={x:a.x+u.x,y:a.y+u.y},y={x:a.x+h.x,y:a.y+h.y},p={x:s.x+h.x,y:s.y+h.y};r.push(intersect({start:m,end:d},{start:y,end:p}))}return r}function normalizeEvent(e){var t,r=null;if(e.originalEvent instanceof TouchEvent){if(t="touchend"==e.type?e.originalEvent.changedTouches:e.originalEvent.touches,1!=t.length)return;r={pageX:t[0].pageX,pageY:t[0].pageY}}else r={pageX:e.pageX,pageY:e.pageY};return r}function getCentroid(e){var t={x:0,y:0},r=0,n=0,o=0,i=0,a=0,s=0,l=0;for(l=0;l<e.length-1;++l)n=e[l].x,o=e[l].y,i=e[l+1].x,a=e[l+1].y,s=n*a-i*o,r+=s,t.x+=(n+i)*s,t.y+=(o+a)*s;return n=e[l].x,o=e[l].y,i=e[0].x,a=e[0].y,s=n*a-i*o,r+=s,t.x+=(n+i)*s,t.y+=(o+a)*s,r*=.5,t.x/=6*r,t.y/=6*r,t}var blue=new THREE.Color("#0000ff"),gray=new THREE.Color("#eeeeee"),invalidStroke="#ff0000",blackStroke="#888888",grayStroke="#bbbbbb",white="rgba(255,255,255,.8)",metFill="hsla(190, 80%, 50%, .4)",metStroke="hsla(190, 80%, 50%, .8)",touchFill="hsla(0, 0%, 0%, .1)",touchStroke="hsla(0, 0%, 0%, .4)",gridColor="rgba(0,0,0,.2)",thickness=8,lineMaterial=new THREE.LineBasicMaterial({color:255}),tempWindow,GRID_SIZE=20,CEILING_HEIGHT={MIN:2,DEFAULT:2.7,MAX:10},ONE_SIXTH_PI=Math.PI/6,ONE_FOURTH_PI=Math.PI/4,currentRoom=sessionStorage.currentRoom?JSON.parse(sessionStorage.currentRoom):null,rooms=sessionStorage.rooms?JSON.parse(sessionStorage.rooms):[],houseType=null,previousCeilingHeight=sessionStorage.previousCeilingHeight?sessionStorage.previousCeilingHeight:CEILING_HEIGHT.DEFAULT,initializeRoom=function(){return{topLevel:!0,roomType:"",roomLines:"",roomPoints:"",noOfExternal:0,currentExternal:-1}};angular.module("myApp",["ngRoute","myApp.filters","myApp.services","myApp.directives","myApp.controllers","ui.slider"]).config(["$routeProvider",function(e){e.when("/settings",{templateUrl:"partials/settings.html",controller:"Settings"}).when("/introduction",{templateUrl:"partials/introduction.html",controller:"Introduction"}).when("/house-overview",{templateUrl:"partials/house-overview.html",controller:"HouseOverview"}).when("/house-type",{templateUrl:"partials/house-type.html",controller:"HouseType"}).when("/room-type",{templateUrl:"partials/room-type.html",controller:"RoomType"}).when("/draw-room",{templateUrl:"partials/draw-room.html",controller:"DrawRoom"}).when("/ceiling-height",{templateUrl:"partials/ceiling-height.html",controller:"CeilingHeight"}).when("/specify-walls",{templateUrl:"partials/specify-walls.html",controller:"SpecifyWalls"}).when("/add-windows",{templateUrl:"partials/add-windows.html",controller:"AddWindows"}).when("/room-specs",{templateUrl:"partials/room-specs.html",controller:"RoomSpecs"}).when("/wall-direction",{templateUrl:"partials/wall-direction.html",controller:"WallDirection"}).otherwise({redirectTo:"/introduction"})}]).run(function(e,t,r){e.goToSettings=function(){t.path("/settings")},e.clearsessionStorage=function(){sessionStorage.removeItem("houseType"),sessionStorage.removeItem("rooms"),sessionStorage.removeItem("currentRoom"),sessionStorage.removeItem("previousCeilingHeight"),r.reload()},e.debugMode=!0,e.$on("$routeChangeSuccess",function(e,t,r){var n=$(".main"),o=n.width(),i=n.height();o=Math.floor(o/GRID_SIZE)*GRID_SIZE,i=Math.floor(i/GRID_SIZE)*GRID_SIZE,n.width(o),n.height(i)})});