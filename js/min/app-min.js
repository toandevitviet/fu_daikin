"use strict";function directionToRadian(e){switch(e){case"n":return 0;case"nw":return 1;case"w":return 2;case"sw":return 3;case"s":return 4;case"se":return 5;case"e":return 6;case"ne":return 7}}function getDirectionName(e){switch(e){case 0:return"North";case 1:return"North West";case 2:return"West";case 3:return"South West";case 4:return"South";case 5:return"South East";case 6:return"East";case 7:return"North East"}}function getRadianFromFixedDirection(e){return e*ONE_FOURTH_PI}function getDirection(e){var t=(Math.floor(e/ONE_SIXTH_PI)+12)%12;switch(t){case 0:return 0;case 1:return 1;case 2:case 3:return 2;case 4:return 3;case 5:case 6:return 4;case 7:return 5;case 8:case 9:return 6;case 11:return 7}}function pointCameraTo(e,t,n,r){var o=t.center(),a=new THREE.Vector3;a.subVectors(o,r.target),n.position.addVectors(n.position,a),n.lookAt(o),r.target.set(o.x,o.y,o.z)}function bboxCenter(e){e.geometry.computeBoundingBox();var t=new THREE.Vector3;return t.x=(geometry.boundingBox.x[1]+geometry.boundingBox.x[0])/2,t.y=(geometry.boundingBox.y[1]+geometry.boundingBox.y[0])/2,t.z=(geometry.boundingBox.z[1]+geometry.boundingBox.z[0])/2,t}function boundingBox(e){var t=(new THREE.Box3).setFromObject(e);return t}function zoomObject(e,t,n,r){var o=boundingBox(e);if(!o.empty()){var a=o.center();pointCameraTo(e,o,t,n);var i=o.size().length()*(r?r:.5),s=i/Math.sin(Math.PI/210*t.fov*.5),l=n.target,c=new THREE.Vector3;c.subVectors(t.position,l),c.setLength(s),t.position.addVectors(c,l),t.updateProjectionMatrix()}}function saveToSessionStorage(){sessionStorage.houseType=houseType,sessionStorage.rooms=JSON.stringify(rooms),sessionStorage.currentRoom=JSON.stringify(currentRoom),sessionStorage.previousCeilingHeight=previousCeilingHeight}function saveSettingsToSessionStorage(){sessionStorage.settings=JSON.stringify(settings)}function addLine(e,t,n,r,o,a,i){var s=new THREE.Geometry;s.vertices.push(new THREE.Vector3(t,n,r)),s.vertices.push(new THREE.Vector3(o,a,i));var l=new THREE.Line(s,lineMaterial);e.add(l)}function calculateOuterInnerLines(e,t,n,r,o){var a=Math.atan(-1/((o-n)/(r-t))),i,s,l,c,u=n>o;return i=t-(u?-1:1)*e*Math.cos(a),s=n-e*Math.sin(a),l=r-(u?-1:1)*e*Math.cos(a),c=o-e*Math.sin(a),{outerX1New:t,outerY1New:n,outerX2New:r,outerY2New:o,innerX1New:i,innerY1New:s,innerX2New:l,innerY2New:c}}function getLineIntersection(e,t,n,r,o,a,i,s){var l=((e*r-t*n)*(o-i)-(e-n)*(o*s-a*i))/((e-n)*(a-s)-(t-r)*(o-i)),c=((e*r-t*n)*(a-s)-(t-r)*(o*s-a*i))/((e-n)*(a-s)-(t-r)*(o-i));return{x:l,y:c}}function constructRoom(e,t,n,r,o,a){var i=expandPoly(e.polygon,n),s=i.vertices,l=e.polygon.vertices,c=[],u=new THREE.Object3D,d=new THREE.Object3D,g=new THREE.Shape;g.moveTo(e.polygon.vertices[0].x,e.polygon.vertices[0].y);for(var m=1;m<e.polygon.vertices.length;++m)g.lineTo(e.polygon.vertices[m].x,e.polygon.vertices[m].y);g.lineTo(e.polygon.vertices[0].x,e.polygon.vertices[0].y);var h=new THREE.ExtrudeGeometry(g,{amount:1,bevelEnabled:!1}),p=new THREE.MeshLambertMaterial({shading:THREE.FlatShading,color:gray});p.side=THREE.DoubleSide;var y=new THREE.Mesh(h);y.geometry.computeFaceNormals(),y.geometry.computeVertexNormals(),y.position.y=0,y.rotation.x=Math.PI/2;var v=new ThreeBSP(y).toMesh(p);v.geometry.computeFaceNormals(),v.geometry.computeVertexNormals();for(var x=0;x<e.polygon.edges.length;++x){var w=getPointIdx(e.polygon.edges[x].start.id,l),E=getPointIdx(e.polygon.edges[x].end.id,l),f=s[w],T=l[w],S=s[E],b=l[E],R=new THREE.Shape;R.moveTo(f.x,f.y),R.lineTo(T.x,T.y),R.lineTo(b.x,b.y),R.lineTo(S.x,S.y),R.lineTo(f.x,f.y);var H=new THREE.ExtrudeGeometry(R,{amount:r,bevelEnabled:!1}),N=new THREE.MeshLambertMaterial({shading:THREE.FlatShading,color:o(x,e.polygon.edges[x])});N.side=THREE.DoubleSide;var M=new THREE.Mesh(H);if(M.geometry.computeFaceNormals(),M.geometry.computeVertexNormals(),M.position.y=r,M.rotation.x=Math.PI/2,(a&&a(x,e.polygon.edges[x])||!a)&&e.polygon.edges[x].windows&&e.polygon.edges[x].windows.length>0){for(var I=new ThreeBSP(M),D=t[x].windows,A=new THREE.Object3D,B=0;B<D.length;++B){var P=new THREE.BoxGeometry(D[B].width,D[B].height,D[B].thickness),O=new THREE.MeshNormalMaterial({transparent:!0,opacity:.25});O.side=THREE.DoubleSide;var k=new THREE.Mesh(P,O);k.overdraw=!0,k.applyMatrix(D[B].rotationMatrix),k.position.set(D[B].x,D[B].y,D[B].z);var C=new ThreeBSP(k);C=C.intersect(I),I=I.subtract(C),A.add(k)}var z=I.toMesh(N);z.geometry.computeFaceNormals(),z.geometry.computeVertexNormals(),A.add(z),u.add(A),M=A}else{var z=new ThreeBSP(M).toMesh(N);z.geometry.computeFaceNormals(),z.geometry.computeVertexNormals(),u.add(z),M=z}M.idx=x,c.push(M)}return d.add(v),d.add(u),{parent:u,superParent:d,objects:c,floor:v,expandedPoly:i}}function init3DRoom(e,t,n,r,o,a,i,s){var l=t.width(),c=t.height(),u=e.ceilingHeight*GRID_SIZE,d=new THREE.PerspectiveCamera(45,l/c,1,6e3);d.position.y=800,d.position.z=1500;var g=new THREE.OrbitControls(d,t[0]);g.maxPolarAngle=Math.PI/2-.001,g.minDistance=0,g.maxDistance=4e3;var m=new THREE.Scene,h=new THREE.PlaneGeometry(1e5,1e5),p=new THREE.MeshBasicMaterial({color:14540253}),y=new THREE.Projector,v=new THREE.Vector3(0,1e4,.5),x=new THREE.AmbientLight(7829367);m.add(x);var w=new THREE.DirectionalLight(16777215);w.position.x=-.3704497358455519,w.position.y=.8303481835923215,w.position.z=-.4162798184117182,w.position.normalize(),w.castShadow=!1,m.add(w);var w=new THREE.DirectionalLight(8421504);w.position.x=.4314326373398046,w.position.y=.6372289487054973,w.position.z=.6385962310957584,w.position.normalize(),w.castShadow=!1,m.add(w);var E;a?E=a:(E=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),E.setClearColor(0,0)),E.setSize(l,c),t.append(E.domElement);var f=e.polygon.edges,t=constructRoom(e,f,thickness,u,n,i),T=t.parent,S=t.objects,b=t.floor,R=t.superParent,H=(new THREE.Box3).setFromObject(T),N=H.max.x-H.min.x,M=H.max.y-H.min.y,I=H.max.z-H.max.z,D=1;if(T.scale.x=D,T.scale.z=D,T.scale.y=D,o&&e.externalWallsIndexes.length>0){var A=e.polygon.edges[e.externalWallsIndexes[0]],B=(e.isClockwise?Math.PI+A.tetha:A.tetha)+getRadianFromFixedDirection(A.direction);R.rotation.y=B}return m.add(R),zoomObject(R,d,g,s),{controls:g,scene:m,camera:d,renderer:E,parent:T,floor:b,objects:S,superParent:R}}function vecUnit(e){var t=Math.sqrt(e.x*e.x+e.y*e.y);return{x:e.x/t,y:e.y/t}}function vecMul(e,t){return{x:e.x*t,y:e.y*t}}function vecDot(e,t){return e.x*t.x+e.y*t.y}function vecRot90CW(e){return{x:e.y,y:-e.x}}function vecRot90CCW(e){return{x:-e.y,y:e.x}}function intersect(e,t){var n=e.end.x-e.start.x,r=t.start.x-t.end.x,o=t.start.x-e.start.x,a=e.end.y-e.start.y,i=t.start.y-t.end.y,s=t.start.y-e.start.y,l=(r*s-i*o)/(a*r-n*i);return{x:e.start.x+l*(e.end.x-e.start.x),y:e.start.y+l*(e.end.y-e.start.y)}}function polyIsCw(e){return vecDot(vecRot90CW({x:e[1].x-e[0].x,y:e[1].y-e[0].y}),{x:e[2].x-e[1].x,y:e[2].y-e[1].y})>=0}function getPointIdx(e,t){for(var n=0;n<t.length;n++)if(t[n].id==e)return n}function leftSide(e,t,n){return(n.x-e.x)*(t.y-e.y)-(t.x-e.x)*(n.y-e.y)}function isReflexVertex(e,t){var n=e.vertices[t],r=e.vertices[(t+1)%e.vertices.length],o=e.vertices[(t+e.vertices.length-1)%e.vertices.length];return leftSide(o,r,n)<0?!0:!1}function getLength(e,t,n,r){return Math.sqrt(Math.pow(n-e,2)+Math.pow(r-t,2))}function inwardEdgeNormal(e){var t=e.end.x-e.start.x,n=e.end.y-e.start.y,r=Math.sqrt(t*t+n*n);return{x:-n/r,y:t/r}}function outwardEdgeNormal(e){var t=inwardEdgeNormal(e);return{x:-t.x,y:-t.y}}function isClockwise(e){for(var t=0,n=0;n<e.length;n++){var r=e[n],o=e[(n+1)%e.length];t+=(o.x-r.x)*(o.y+r.y)}return t>0}function createPolygon(e){for(var t={vertices:e},n=[],r=e.length>0?e[0].x:void 0,o=e.length>0?e[0].y:void 0,a=r,i=o,s=0;s<t.vertices.length;s++){e[s].isReflex=isReflexVertex(t,s);var l={start:e[s],end:e[(s+1)%e.length],id:s};l.outwardNormal=outwardEdgeNormal(l),l.inwardNormal=inwardEdgeNormal(l);var c=getLength(l.start.x,l.start.y,l.end.x,l.end.y)/GRID_SIZE*1;c=+c.toFixed(4);var u=Math.atan2(l.end.y-l.start.y,l.end.x-l.start.x);l.length=c,l.tetha=u,l.direction=0,l.windows=[],l.external=!1,n.push(l);var d=e[s].x,g=e[s].y;r=Math.min(d,r),o=Math.min(g,o),a=Math.max(d,a),i=Math.max(g,i)}return t.edges=n,t.minX=r,t.minY=o,t.maxX=a,t.maxY=i,t.closed=!0,t}function createOffsetEdge(e,t,n){return{start:{x:e.start.x+t,y:e.start.y+n},end:{x:e.end.x+t,y:e.end.y+n}}}function expandPoly(e,t){for(var n=[],r=0;r<e.edges.length;r++){var o=e.edges[r],a=o.outwardNormal.x*t,i=o.outwardNormal.y*t;n.push(createOffsetEdge(o,a,i))}for(var s=[],r=0;r<n.length;r++){var l=n[r],c=n[(r+n.length-1)%n.length],u=edgesIntersection(c,l);if(u)s.push(u);else{var d=e.edges[r].start;appendArc(s,d,t,c.end,l.start,!1)}}var g=createPolygon(s);return g.offsetEdges=n,g}function normalizeEvent(e){var t,n=null;if(e.originalEvent instanceof TouchEvent){if(t="touchend"==e.type?e.originalEvent.changedTouches:e.originalEvent.touches,1!=t.length)return;n={pageX:t[0].pageX,pageY:t[0].pageY}}else n={pageX:e.pageX,pageY:e.pageY};return n}function edgesIntersection(e,t){var n=e.start.x,r=e.end.x,o=e.start.y,a=e.end.y,i=t.start.x,s=t.end.x,l=t.start.y,c=t.end.y,u=((n*a-o*r)*(i-s)-(n-r)*(i*c-l*s))/((n-r)*(l-c)-(o-a)*(i-s)),d=((n*a-o*r)*(l-c)-(o-a)*(i*c-l*s))/((n-r)*(l-c)-(o-a)*(i-s));return{x:u,y:d}}function getCentroid(e){var t={x:0,y:0},n=0,r=0,o=0,a=0,i=0,s=0,l=0;for(l=0;l<e.length-1;++l)r=e[l].x,o=e[l].y,a=e[l+1].x,i=e[l+1].y,s=r*i-a*o,n+=s,t.x+=(r+a)*s,t.y+=(o+i)*s;return r=e[l].x,o=e[l].y,a=e[0].x,i=e[0].y,s=r*i-a*o,n+=s,t.x+=(r+a)*s,t.y+=(o+i)*s,n*=.5,t.x/=6*n,t.y/=6*n,t}var blue=new THREE.Color("#e74c3c"),gray=new THREE.Color("#5BC9F4"),invalidStroke="#ff0000",blackStroke="#888888",grayStroke="#bbbbbb",white="rgba(255,255,255,.8)",metFill="hsla(190, 80%, 50%, .4)",metStroke="hsla(190, 80%, 50%, .8)",touchFill="hsla(0, 0%, 0%, .1)",touchStroke="hsla(0, 0%, 0%, .4)",gridColor="rgba(0,0,0,.2)",thickness=8,lineMaterial=new THREE.LineBasicMaterial({color:255}),tempWindow,renderers=[],GRID_SIZE=20,CEILING_HEIGHT={MIN:2,DEFAULT:2.7,MAX:6},MAX_ROOM_PER_ROW=3,ONE_SIXTH_PI=Math.PI/6,ONE_FOURTH_PI=Math.PI/4,currentRoom=sessionStorage.currentRoom?JSON.parse(sessionStorage.currentRoom):null,rooms=sessionStorage.rooms?JSON.parse(sessionStorage.rooms):[],houseType=sessionStorage.houseType?sessionStorage.houseType:null,previousCeilingHeight=sessionStorage.previousCeilingHeight?sessionStorage.previousCeilingHeight:CEILING_HEIGHT.DEFAULT,settings=sessionStorage.settings?JSON.parse(sessionStorage.settings):{hideHelp:!1,audioMuted:!1},TurbulenzEngine,graphicsDevice,draw2D,initializeRoom=function(){return{topLevel:!0,roomType:"",roomLines:"",roomPoints:"",noOfExternal:0,currentExternal:-1}};angular.module("myApp",["ngRoute","ngAnimate","myApp.filters","myApp.services","myApp.directives","myApp.controllers","ui.slider"]).config(["$routeProvider",function(e){e.when("/settings",{templateUrl:"partials/settings.html",controller:"Settings"}).when("/introduction",{templateUrl:"partials/introduction.html",controller:"Introduction"}).when("/house-overview",{templateUrl:"partials/house-overview.html",controller:"HouseOverview"}).when("/house-type",{templateUrl:"partials/house-type.html",controller:"HouseType"}).when("/room-type",{templateUrl:"partials/room-type.html",controller:"RoomType"}).when("/draw-room",{templateUrl:"partials/draw-room.html",controller:"DrawRoom"}).when("/ceiling-height",{templateUrl:"partials/ceiling-height.html",controller:"CeilingHeight"}).when("/specify-walls",{templateUrl:"partials/specify-walls.html",controller:"SpecifyWalls"}).when("/add-windows",{templateUrl:"partials/add-windows.html",controller:"AddWindows"}).when("/room-specs/:id",{templateUrl:"partials/room-specs.html",controller:"RoomSpecs"}).when("/wall-direction",{templateUrl:"partials/wall-direction.html",controller:"WallDirection"}).when("/algo",{templateUrl:"partials/algo.html",controller:"Algo"}).otherwise({redirectTo:"/introduction"})}]).run(function(e,t,n,r){function o(e,t){function n(e){function n(){o?setTimeout(n,100):TurbulenzEngine.request("img/"+m+".json",r)}function r(e){var n=new spine.SkeletonJson(new spine.AtlasAttachmentLoader(d));n.scale=t,g=n.readSkeletonData(JSON.parse(e)),i()}var o=0;d=new spine.Atlas(e,{load:function(e,t,n){o++,graphicsDevice.createTexture({src:"img/"+t,mipmaps:!0,onload:function(t){e.rendererObject=t,e.width=t.width,e.height=t.height,n.updateUVs(e),o--}})},unload:function(e){e.destroy()}}),n()}m=e,TurbulenzEngine.request("img/"+m+".atlas",n)}function a(e,t,n){switch(c){case 0:e.addAnimationByName(0,"hello",!1,5);break;case 1:n.clearTracks(),e.setAnimationByName(0,"jump");break;case 2:n.addAnimationByName(0,"foot-tap",!0,0),e.addAnimationByName(0,"shake-body",!1,10);break;case 3:n.addAnimationByName(0,"swing-leg",!0,5),e.addAnimationByName(0,"shake-head",!1,10);break;case 4:n.addAnimationByName(0,"look-around",!1,0),n.addAnimationByName(0,"right-wink",!1,10),e.addAnimationByName(0,"bounce",!1,12);break;case 5:e.clearTracks(),n.clearTracks(),e.addAnimationByName(0,"jump",!1,.5),n.addAnimationByName(0,"float",!0,2)}}function i(){function e(){if(graphicsDevice){var e=TurbulenzEngine.time-d;d=TurbulenzEngine.time,o.update(e),i.update(e),r.update(e),o.apply(t),i.apply(t),r.apply(t),t.updateWorldTransform(),graphicsDevice.clear(l,1),u.begin(draw2D.blend.alpha),s(u,t),u.end(),graphicsDevice.endFrame()}}spine.Bone.yDown=!1;var t=new spine.Skeleton(g);t.x=160,t.y=440,t.setToSetupPose(),t.updateWorldTransform();var n=new spine.AnimationStateData(g),r=new spine.AnimationState(n),o=new spine.AnimationState(n),i=new spine.AnimationState(n);r.addAnimationByName(0,"hello",!1,5),i.setAnimationByName(0,"float",!0),o.setAnimationByName(0,"blink",!1),o.addAnimationByName(0,"blink",!0,10),r.onComplete=function(e,t){e==r.tracks.length-1&&t>=1&&(c=(c+1)%6,setTimeout(function(){a(r,o,i)},5e3))},r.onEvent=function(e,t){};var l=[0,0,0,0],u=new SpriteBatch(draw2D),d=TurbulenzEngine.time;TurbulenzEngine.setInterval(e,1e3/60)}function s(e,t){for(var n=t.drawOrder,r=0,o=n.length;o>r;r++){var a=n[r],i=a.attachment;if(i instanceof spine.RegionAttachment){i.computeVertices(t.x,t.y,a.bone,h);var s=a.data.additiveBlending?draw2D.blend.additive:draw2D.blend.alpha;e.blendMode!=s&&(e.end(),e.begin(s)),e.add(i.rendererObject.page.rendererObject,h[0],h[1],h[6],h[7],h[2],h[3],h[4],h[5],t.r*a.r,t.g*a.g,t.b*a.b,t.a*a.a,i.uvs[0],i.uvs[1],i.uvs[4],i.uvs[5])}}}function l(){e.boolShowHelp=!1,e.settings.audioMuted||$("#audio")[0].play()}var c=0,u=$(".mascot-img")[0];TurbulenzEngine=WebGLTurbulenzEngine.create({canvas:u}),graphicsDevice=TurbulenzEngine.createGraphicsDevice({alpha:!0,multisample:4}),draw2D=Draw2D.create({graphicsDevice:graphicsDevice}),o("pichon",.8);var d,g,m,h=[];e.settings=settings,e.muteAudio=function(){var t=!e.settings.audioMuted;e.settings.audioMuted=t,$("#audio")[0].volume=t?0:1,t||$("#audio")[0].play(),saveSettingsToSessionStorage()},e.showHelp=function(t){e.currHelpIdx=0,e.boolShowHelp=t},e.goToSettings=function(){t.path("/settings")},e.clearsessionStorage=function(){sessionStorage.removeItem("houseType"),sessionStorage.removeItem("rooms"),sessionStorage.removeItem("currentRoom"),sessionStorage.removeItem("previousCeilingHeight"),sessionStorage.removeItem("settings"),n.reload()},e.debugMode=!0,e.$on("$routeChangeSuccess",function(t,n,o){settings.hideHelp||(e.boolShowHelp=!0),n&&n.$$route&&"Introduction"!=n.$$route.controller&&r(function(){var e=$(".main"),t=e.width(),n=e.height();t=Math.floor(t/GRID_SIZE)*GRID_SIZE,n=Math.floor(n/GRID_SIZE)*GRID_SIZE,e.width(t),e.height(n)})}),l()});